<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Adversys</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script>
        let CLIENT_ID = '24454oleqph3653lbtqb3bn5e7';
        const AUTH_URL = 'https://adversys.auth.us-east-1.amazoncognito.com';
        let redirect_uri = 'https://jamespeirano.github.io/excelHtml/redirect.html';

        async function getSelectedRange() {
            return await Excel.run(async (context) => {
                const range = context.workbook.getSelectedRange();
                range.load("address");
                await context.sync();
                return range.address.split("!").slice(-1)[0];
            });
        }

        async function updateRangeSelect() {
            try {
                const selection = await getSelectedRange();
                document.getElementById('selectionDisplay').innerText = `[${selection}]`;
            } catch (error) {
                console.error('An error occurred:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            Office.onReady(async (info) => {
                if (info.host === Office.HostType.Excel) {
                    document.getElementById('loginRequest').addEventListener('click', function() {
                        Office.context.ui.displayDialogAsync(
                            `${AUTH_URL}/login?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${redirect_uri}&scope=email+openid+phone`,
                            { height: 60, width: 30 },
                            function (result) {
                                let dialog = result.value;
                                dialog.addEventHandler(Office.EventType.DialogMessageReceived, function (message) {
                                    const authCode = message.message;
                                    document.getElementById('loginRequest').innerText = 'Logged in';
                                    localStorage.setItem('authCode', authCode);
                                    dialog.close();
                                });
                            }
                        );
                    });

                    // Set up selection change event listener
                    Excel.run(async (context) => {
                        const sheet = context.workbook.worksheets.getActiveWorksheet();
                        sheet.onSelectionChanged.add(updateRangeSelect);
                        await context.sync();
                    }).catch(function (error) {
                        console.log("Error: " + error);
                    });

                    // Update range on load
                    updateRangeSelect();
                }
            });
        });
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #333;
            color: #fff;
        }

        button {
            background-color: #6c63ff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 16px;
            border-radius: 5px;
        }

        #loginRequest {
            background-color: #6c63ff;
            color: #fff;
            font-size: 16px;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 10px;
        }

        #selectionDisplay {
            color: #6c63ff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Adversys</h1>
    <p id="emailDisplay"></p>
    <button id="loginRequest">Log In with Cognito</button>
    <p>Select cells in your spreadsheet to see the selection displayed below:</p>
    <p id="selectionDisplay">[None]</p>
</body>
</html>
